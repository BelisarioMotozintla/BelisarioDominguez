{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2>Registrar Paciente</h2>
  <form method="POST">
    {% include 'paciente/_form.html' %}
    <button type="submit" class="btn btn-primary">Guardar</button>
  
  </form>
</div>
<a href="{{ volver_url }}" class="btn btn-secondary">Regresar</a>
<script>
    document.querySelector("form").addEventListener("submit", function(e) {
    const fecha = document.querySelector('input[name="fecha_nacimiento"]').value;
    if (fecha) {
        const f = new Date(fecha);
        const hoy = new Date();
        if (f < new Date("1900-01-01") || f > hoy) {
            e.preventDefault();
            alert("La fecha debe estar entre 1900 y hoy.");
        }
    }
});
document.addEventListener('DOMContentLoaded', function () {
    const esCronico = document.getElementById('es_cronico');
    const tipoCronicidad = document.getElementById('tipo_cronicidad');
    const sexo = document.getElementById('sexo');
    const embarazada = document.getElementById('esta_embarazada');
    const tipoRelacion = document.getElementById('tipo_relacion');
    const unidad = document.getElementById('id_unidad');
    const planificacion = document.getElementById('planificacion'); // 游녣 aqu칤 lo agregamos

    function actualizarTipoCronicidad() {
        tipoCronicidad.disabled = (esCronico.value !== 'S칤');
    }

    function actualizarEmbarazo() {
        if (sexo.value === 'M') {
            embarazada.value = 'No';
            embarazada.disabled = true;
        } else {
            // Si es mujer y no est치 planificando, habilitar embarazo
            embarazada.disabled = planificacion.checked;
            if (planificacion.checked) {
                embarazada.value = 'No'; // forzar "No"
            }
        }
    }

    function actualizarPlanificacion() {
        if (planificacion.checked) {
            embarazada.value = 'No';
            embarazada.disabled = true;
        } else {
            actualizarEmbarazo();
        }
    }

    function seleccionarUnidadBelisario() {
        if (tipoRelacion.value === 'Universo') {
            const options = unidad.options;
            for (let i = 0; i < options.length; i++) {
                if (options[i].textContent.includes('BELISARIO DOMINGUEZ')) {
                    unidad.value = options[i].value;
                    break;
                }
            }
        }
    }

    function actualizarEstado() {
        if (esCronico.value === "No") {
            tipoCronicidad.value = "Otro";
            tipoCronicidad.disabled = true;
        } else {
            tipoCronicidad.disabled = false;
        }
    }

    // Eventos
    esCronico.addEventListener("change", actualizarEstado);
    esCronico.addEventListener('change', actualizarTipoCronicidad);
    sexo.addEventListener('change', actualizarEmbarazo);
    tipoRelacion.addEventListener('change', seleccionarUnidadBelisario);
    planificacion.addEventListener('change', actualizarPlanificacion);

    // Inicializar al cargar la p치gina
    actualizarEstado();
    actualizarTipoCronicidad();
    actualizarEmbarazo();
    actualizarPlanificacion();
});

// Funci칩n para generar los primeros 17 caracteres de la CURP
function generarCurp(nombreCompleto, fechaNac, sexo, estado) {
    nombreCompleto = nombreCompleto.trim().toUpperCase();
    let partes = nombreCompleto.split(" ");
    if (partes.length < 3) return "";

    let paterno = partes[partes.length - 2];
    let materno = partes[partes.length - 1];
    let nombres = partes.slice(0, -2).join(" ");
    let primerNombre = nombres.split(" ")[0];

    function primeraVocal(str) {
        let s = str.slice(1);
        let match = s.match(/[AEIOU]/);
        return match ? match[0] : "X";
    }
    function primeraConsonante(str) {
        let s = str.slice(1);
        let match = s.match(/[^AEIOU]/);
        return match ? match[0] : "X";
    }

    let curp = "";
    curp += paterno[0];
    curp += primeraVocal(paterno);
    curp += materno[0] || "X";

    if ((primerNombre === "JOSE" || primerNombre === "MARIA") && nombres.split(" ").length > 1) {
        curp += nombres.split(" ")[1][0];
    } else {
        curp += primerNombre[0];
    }

    let fecha = fechaNac.replace(/-/g, "");
    curp += fecha.substring(2, 8); // AAMMDD
    curp += sexo;                  // H o M
    curp += estado;                // Estado de nacimiento

    curp += primeraConsonante(paterno);
    curp += primeraConsonante(materno);
    curp += primeraConsonante(primerNombre);

    return curp; // Devuelve 17 caracteres
}

// Evento para actualizar la CURP autom치ticamente
document.querySelectorAll('input[name="nombre"], input[name="fecha_nacimiento"], select[name="sexo"], select[name="estado"]')
.forEach(el => {
    el.addEventListener("input", () => {
        let nombre = document.querySelector('input[name="nombre"]').value;
        let fecha = document.querySelector('input[name="fecha_nacimiento"]').value;
        let sexoSelect = document.querySelector('select[name="sexo"]').value;
        let estado = document.querySelector('select[name="estado"]').value;

        if (nombre && fecha && sexoSelect && estado) {
            let sexoCurp = sexoSelect === "M" ? "H" : "M";
            let curp17 = generarCurp(nombre, fecha, sexoCurp, estado);

            let anio = fecha.split("-")[0];

            // AJAX para d칤gito verificador
            fetch("/paciente/calcular_digito", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({curp17: curp17, anio: anio})
            })
            .then(res => res.json())
            .then(data => {
                document.querySelector('input[name="curp"]').value = curp17 + data.digito;
            });
        }
    });
});
</script>

{% endblock %}
