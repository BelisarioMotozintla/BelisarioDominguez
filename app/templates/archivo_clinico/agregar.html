{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">

  <h2>Agregar Archivo Clínico</h2>

  <form method="POST" onsubmit="return validarNumeroExpediente()">

    <div class="mb-3">
  <label for="numero_expediente">Número de Expediente:</label>
  <input type="text" name="numero_expediente" id="numero_expediente"
         class="form-control" required value="{{ candidato_numero }}">
  <div id="error_numero" style="color: red; display: none; margin-top: 5px;">
    Este número ya existe, por favor elige otro.
  </div>
</div>

    <div class="mb-3">
      <label>Buscar paciente (por nombre o CURP):</label>
      <input type="text" id="buscar_paciente" class="form-control" placeholder="Ej. Juan Pérez o CURP" autocomplete="off">
      <input type="hidden" name="id_paciente" id="id_paciente">
      <ul id="sugerencias" class="list-group mt-2"></ul>
    </div>

    <div class="mb-3">
      <label>Ubicación física:</label>
      <input type="text" name="ubicacion_fisica" class="form-control" placeholder="ARCHIVERO 1, GAVETA 2, FINAL,MEDIO O PRINCIPIO ">
    </div>

    <div class="mb-3">
      <label>Estado:</label>
      <select name="estado" class="form-select" required>
        <option value="disponible">Disponible</option>
        <option value="prestado">Prestado</option>
        <option value="extraviado">Extraviado</option>
      </select>
    </div>

    <div class="mb-3">
      <label>Tipo de archivo:</label>
      <input type="text" name="tipo_archivo" class="form-control" value="FISICO"> 
    </div>

    <div class="mb-3">
  <label for="fecha_creacion">Fecha de creación:</label>
  <input type="date" id="fecha_creacion" name="fecha_creacion"
         class="form-control" value="{{ fecha_hoy }}" readonly>
</div>

    <button type="submit" class="btn btn-primary">Guardar</button>
    <a href="{{ url_for('archivo_clinico.index') }}" class="btn btn-secondary">Cancelar</a>
  </form>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("buscar_paciente");
    const lista = document.getElementById("sugerencias");
    const hiddenId = document.getElementById("id_paciente");

    input.addEventListener("input", function () {
      const query = input.value.trim();
      lista.innerHTML = '';
      hiddenId.value = '';

      if (query.length < 2) return;

      fetch(`/paciente/buscar?query=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          data.forEach(p => {
            const item = document.createElement("li");
            item.classList.add("list-group-item", "list-group-item-action");
            item.textContent = `${p.nombre} - ${p.curp}`;
            item.addEventListener("click", () => {
              input.value = `${p.nombre}`;
              hiddenId.value = p.id_paciente;
              lista.innerHTML = '';
            });
            lista.appendChild(item);
          });
        });
    });
  });

  async function validarNumeroExpediente() {
    const numeroInput = document.getElementById('numero_expediente');
    const errorDiv = document.getElementById('error_numero');
    const numero = numeroInput.value.trim();

    if (!numero) {
      errorDiv.style.display = 'none';
      return true;  // required se encarga del vacío
    }

    try {
      const response = await fetch(`/validar_numero_expediente?numero=${encodeURIComponent(numero)}`);
      const data = await response.json();

      if (data.existe) {
        errorDiv.style.display = 'block';
        numeroInput.focus();
        return false; // evita enviar formulario
      } else {
        errorDiv.style.display = 'none';
        return true; // permite enviar
      }
    } catch (error) {
      console.error('Error validando número:', error);
      // Si hay error en la validación, dejamos enviar igual
      return true;
    }
  }
  </script>

</div>
{% endblock %}
