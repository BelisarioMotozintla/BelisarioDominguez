{% extends "base.html" %}

{% block content %}
<h2>ğŸ“ Expediente de {{ paciente.nombre }}</h2>

<!-- DATOS GENERALES -->
<div class="card p-3 mt-3">
    <h4>ğŸ§ Datos Generales</h4>
    <p><strong>Edad:</strong> {{ paciente.edad }}</p>
    <p><strong>CURP:</strong> {{ paciente.curp }}</p>
    <p><strong>Celular:</strong> {{ paciente.celular }}</p>
    <p><strong>DirecciÃ³n:</strong> {{ paciente.direccion }}, {{ paciente.municipio }}</p>
</div>

<!-- ARCHIVO CLÃNICO -->
{% if archivo %}
<div class="card p-3 mt-3">
    <h4>ğŸ—‚ï¸ Archivo ClÃ­nico FÃ­sico</h4>
    <p><strong>NÃºmero de expediente:</strong> {{ archivo.numero_expediente }}</p>
    <p><strong>UbicaciÃ³n:</strong> {{ archivo.ubicacion_fisica }}</p>
    <p><strong>Fecha de creaciÃ³n:</strong> {{ archivo.fecha_creacion.strftime('%d/%m/%Y') }}</p>

    <a href="{{ url_for('archivo_clinico.editar_archivo', id=archivo.id_archivo) }}" class="btn btn-warning btn-sm">Editar</a>
    
</div>
{% else %}
<div class="alert alert-warning mt-3">
    âš ï¸ Este paciente aÃºn NO tiene expediente fÃ­sico.
    <br>
    <a href="{{ url_for('archivo_clinico.nuevo_archivo', paciente_id=paciente.id_paciente) }}"
       class="btn btn-success btn-sm mt-2">Crear expediente</a>
</div>
{% endif %}

{% if archivo %}
<hr>

<h4>ğŸ“¤ Registro de Solicitudes del Expediente</h4>

{% if solicitudes %}
<table class="table table-bordered table-striped">
    <thead class="table-light">
        <tr>
            <th>Fecha solicitud</th>
            <th>Servicio</th>
            <th>Solicita</th>
            <th>Autoriza</th>
            <th>Entrega</th>
            <th>DevoluciÃ³n</th>
            <th>Estado</th>
        </tr>
    </thead>
    <tbody>
        {% for s in solicitudes %}
        <tr>
            <td>{{ s.fecha_solicitud.strftime('%d/%m/%Y %H:%M') }}</td>
            <td>{{ s.servicio.nombre if s.servicio else '-' }}</td>
            <td>{{ s.usuario_solicita.nombre }}</td>
            <td>{{ s.usuario_autoriza.nombre if s.usuario_autoriza else '-' }}</td>
            <td>
                {% if s.fecha_entrega %}
                    {{ s.fecha_entrega.strftime('%d/%m/%Y %H:%M') }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td>
                {% if s.fecha_devolucion %}
                    {{ s.fecha_devolucion.strftime('%d/%m/%Y %H:%M') }}
                {% else %}
                    <span class="badge bg-warning text-dark">Pendiente</span>
                {% endif %}
            </td>
            <td>
                {% if s.estado_solicitud == 'pendiente' %}
                    <span class="badge bg-secondary">Pendiente</span>
                {% elif s.estado_solicitud == 'entregado' %}
                    <span class="badge bg-primary">Entregado</span>
                {% elif s.estado_solicitud == 'devuelto' %}
                    <span class="badge bg-success">Devuelto</span>
                {% elif s.estado_solicitud == 'cancelado' %}
                    <span class="badge bg-danger">Cancelado</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="alert alert-info">
    ğŸ“ Este expediente no tiene solicitudes registradas.
</div>
{% endif %}

<a href="{{ url_for('archivo_clinico.nueva_solicitud', archivo_id=archivo.id_archivo) }}"
   class="btn btn-primary btn-sm">
   Nueva solicitud de expediente
</a>
{% endif %}

<hr>

<!-- HISTORIAL DE CITAS -->
<h4>ğŸ“… Historial de Citas</h4>
<table class="table table-bordered">
    <thead class="table-light">
        <tr>
            <th>Fecha</th>
            <th>DuraciÃ³n</th>
            <th>Estado</th>
            <th>AcciÃ³n</th>
        </tr>
    </thead>
    <tbody>
        {% for c in citas %}
        <tr>
            <td>{{ c.fecha_hora.strftime('%d/%m/%Y %H:%M') }}</td>
            <td>{{ c.duracion_min }} min</td>
            <td>{{ c.estado if c.estado else 'Pendiente' }}</td>
            <td>
               <a href="{{ url_for('public.detalle_cita', uuid=c.uuid_publico) }}"
                    class="btn btn-sm btn-primary">
                        Ver Detalle
                </a>
        </tr>
        {% endfor %}
    </tbody>
</table>

<a href="{{ url_for('archivo_clinico.index') }}" class="btn btn-secondary mt-3">Volver</a>
{% endblock %}

