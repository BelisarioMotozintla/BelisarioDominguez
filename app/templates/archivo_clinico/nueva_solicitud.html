{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Nueva Solicitud de Expediente</h2>
    <form method="POST">
      <div class="mb-3">
        <label for="id_paciente" class="form-label">Paciente</label>
      <div class="mb-3">
        <label>Buscar paciente (por nombre o CURP):</label>
        <input type="text" id="buscar_paciente" class="form-control" placeholder="Ej. Juan Pérez o CURP" autocomplete="off">
        <input type="hidden" name="id_paciente" id="id_paciente">
        <ul id="sugerencias" class="list-group mt-2"></ul>
      </div>

   
  </div>
  
  <!-- Campo oculto que llenas automáticamente en el backend -->
  <!-- <input type="hidden" name="id_archivo" value="..." /> -->

  <div class="mb-3">
   <label for="id_usuario_solicita">Usuario que solicita</label>
<select name="id_usuario_solicita" id="id_usuario_solicita" class="form-control">
  {% for u in usuarios %}
    <option value="{{ u.id_usuario }}" {% if u.usuario == 'PACIENTE' %}selected{% endif %}>
      {{ u.usuario }}
    </option>
  {% endfor %}
</select>
  </div>
<div class="mb-3">
  <label for="id_servicio" class="form-label">Servicio Solicitante</label>
  <select name="id_servicio" id="id_servicio" class="form-select" required>
    <option value="">Seleccione un servicio</option>
    {% for servicio in servicios %}
      <option value="{{ servicio.id_servicio }}">{{ servicio.nombre_servicio }}</option>
    {% endfor %}
  </select>
</div>
  <button type="submit" class="btn btn-primary">Guardar Solicitud</button>
  <a href="{{ url_for('archivo_clinico.lista_solicitudes') }}" class="btn btn-secondary">Cancelar</a>
</form>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("buscar_paciente");
    const lista = document.getElementById("sugerencias");
    const hiddenId = document.getElementById("id_paciente");

    input.addEventListener("input", function () {
        const query = input.value.trim();
        lista.innerHTML = '';
        hiddenId.value = '';

        if (query.length < 2) return;

        fetch(`/paciente/buscar?query=${query}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(p => {
                    const item = document.createElement("li");
                    item.classList.add("list-group-item", "list-group-item-action");
                    item.textContent = `${p.nombre} - ${p.curp}`;
                    item.addEventListener("click", () => {
                        input.value = `${p.nombre}`;
                        hiddenId.value = p.id_paciente;
                        lista.innerHTML = '';
                    });
                    lista.appendChild(item);
                });
            });
    });
});
</script>

</div>
{% endblock %}
