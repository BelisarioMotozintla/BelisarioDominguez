{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Nueva Solicitud de Expediente</h2>
    <form method="POST">
      <div class="mb-3">
        <label for="id_paciente" class="form-label">Paciente</label>
      <div class="mb-3">
  <label>Buscar paciente (por nombre, CURP o expediente):</label>
  <input type="text" id="buscar_paciente" class="form-control" placeholder="Ej. Juan Pérez, CURP o expediente" autocomplete="off">
  
  <!-- Campos ocultos -->
  <input type="hidden" name="id_paciente" id="id_paciente">
  <input type="hidden" name="numero_expediente" id="numero_expediente">

  <!-- Lista de sugerencias -->
  <ul id="sugerencias" class="list-group mt-2"></ul>
</div>
  
  <!-- Campo oculto que llenas automáticamente en el backend -->
  <!-- <input type="hidden" name="id_archivo" value="..." /> -->

  <div class="mb-3">
   <label for="id_usuario_solicita">Usuario que solicita</label>
<select name="id_usuario_solicita" id="id_usuario_solicita" class="form-control">
  {% for u in usuarios %}
    <option value="{{ u.id_usuario }}" {% if u.usuario == 'PACIENTE' %}selected{% endif %}>
      {{ u.usuario }}
    </option>
  {% endfor %}
</select>
  </div>
<div class="mb-3">
  <label for="id_servicio" class="form-label">Servicio Solicitante</label>
  <select name="id_servicio" id="id_servicio" class="form-select" required>
    <option value="">Seleccione un servicio</option>
    {% for servicio in servicios %}
      <option value="{{ servicio.id_servicio }}">{{ servicio.nombre_servicio }}</option>
    {% endfor %}
  </select>
</div>
  <button type="submit" class="btn btn-primary">Guardar Solicitud</button>
  <a href="{{ url_for('archivo_clinico.lista_solicitudes') }}" class="btn btn-secondary">Cancelar</a>
</form>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("buscar_paciente");
    const lista = document.getElementById("sugerencias");
    const hiddenId = document.getElementById("id_paciente");
    const hiddenExp = document.getElementById("numero_expediente");

    input.addEventListener("input", function () {
        const query = input.value.trim();
        lista.innerHTML = '';
        hiddenId.value = '';
        hiddenExp.value = '';

        if (query.length < 2) return;  // Espera mínimo 2 caracteres

        fetch(`/archivo/buscar_json?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                if (!Array.isArray(data) || data.length === 0) {
                    const item = document.createElement("li");
                    item.classList.add("list-group-item");
                    item.textContent = "No se encontraron resultados";
                    lista.appendChild(item);
                    return;
                }

                data.forEach(a => {
                    const item = document.createElement("li");
                    item.classList.add("list-group-item", "list-group-item-action");
                    // Mostrar número de expediente, nombre y CURP
                    item.textContent = `${a.numero_expediente ?? '---'} - ${a.paciente.nombre} - ${a.paciente.curp}`;

                    item.addEventListener("click", () => {
                        // Solo mostrar el nombre en el input
                        input.value = a.paciente.nombre;
                        hiddenId.value = a.paciente.id_paciente;
                        hiddenExp.value = a.numero_expediente ?? '';
                        lista.innerHTML = '';
                    });

                    lista.appendChild(item);
                });
            })
            .catch(err => console.error("Error en búsqueda:", err));
    });

    // Cerrar la lista si se hace clic fuera del input o de la lista
    document.addEventListener("click", function(e) {
        if (!lista.contains(e.target) && e.target !== input) {
            lista.innerHTML = '';
        }
    });
});
</script>

</div>
{% endblock %}
