{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2>Pacientes sin Archivo Clínico</h2>

  <div class="mb-3">
    <label>Buscar paciente (por nombre o CURP):</label>
    <input type="text" id="buscar_paciente" class="form-control" placeholder="Ej. Juan Pérez o CURP" autocomplete="off">
    <ul id="sugerencias" class="list-group mt-2"></ul>
  </div>

  <table class="table table-striped table-bordered mt-3">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>CURP</th>
        <th>Dirección</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody>
      {% for p in pacientes %}
      <tr>
        <td>{{ p.id_paciente }}</td>
        <td>{{ p.nombre }}</td>
        <td>{{ p.curp }}</td>
        <td>{{ p.direccion }}</td>
        <td>
          <a href="{{ url_for('archivo_clinico.agregar_archivo', id_paciente=p.id_paciente) }}" 
             class="btn btn-primary btn-sm">
            Asociar a expediente
          </a>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="5" class="text-center">No se encontraron pacientes sin archivo clínico.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const input = document.getElementById("buscar_paciente");
  const lista = document.getElementById("sugerencias");

  input.addEventListener("input", function () {
    const query = input.value.trim();
    lista.innerHTML = '';
    if (query.length < 2) return;

    fetch(`/paciente/buscar?query=${encodeURIComponent(query)}`)
      .then(res => res.json())
      .then(data => {
        data.forEach(p => {
          const item = document.createElement("li");
          item.classList.add("list-group-item", "list-group-item-action");
          item.textContent = `${p.nombre} - ${p.curp}`;
          item.addEventListener("click", () => {
            window.location.href = `/archivo/alta?id_paciente=${p.id_paciente}`;
          });
          lista.appendChild(item);
        });
      });
  });
});
</script>
{% endblock %}
