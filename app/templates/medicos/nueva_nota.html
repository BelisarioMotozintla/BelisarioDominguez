{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Nueva Nota para Consulta #{{ consulta.id_consulta }}</h2>

  <!-- Mensajes flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST" id="notaForm" action="">
    {{ form.hidden_tag() }}

    <!-- Fecha y Hora ocultas -->
    {{ form.fecha(class="form-control", type="hidden") }}
    {{ form.hora(class="form-control", type="hidden") }}

    <!-- Servicio -->
    <div class="mb-3">
      {{ form.id_servicio.label(class="form-label") }}
      {{ form.id_servicio(class="form-select", title="Seleccione el servicio correspondiente") }}
      <div class="invalid-feedback">Debe seleccionar un servicio</div>
    </div>

    <!-- Signos Vitales -->
     <h5>Signos Vitales</h5>
    <div class="row mb-3">
        <div class="col">{{ form.peso.label }} {{ form.peso(class="form-control") }}</div>
        <div class="col">{{ form.talla.label }} {{ form.talla(class="form-control") }}</div>
        <div class="col">{{ form.imc.label }} {{ form.imc(class="form-control") }}</div>
    </div>
    <div class="row mb-3">
        <div class="col">{{ form.ta.label }} {{ form.ta(class="form-control") }}</div>
        <div class="col">{{ form.fc.label }} {{ form.fc(class="form-control") }}</div>
        <div class="col">{{ form.fr.label }} {{ form.fr(class="form-control") }}</div>
    </div>
    <div class="row mb-3">
        <div class="col">{{ form.temp.label }} {{ form.temp(class="form-control") }}</div>
        <div class="col">{{ form.cc.label }} {{ form.cc(class="form-control") }}</div>
        <div class="col">{{ form.spo2.label }} {{ form.spo2(class="form-control") }}</div>
        <div class="col">{{ form.glicemia.label }} {{ form.glicemia(class="form-control") }}</div>
    </div>
    <!-- SOAP -->
    <h4>SOAP</h4>
    {% for campo in ['presentacion','antecedentes','exploracion_fisica','laboratorio','diagnostico','plan','pronostico'] %}
      <div class="mb-3">
        {{ form[campo].label }}
        {{ form[campo](class="form-control", rows="5", placeholder=form[campo].label.text, title="Ingrese {{ form[campo].label.text.lower() }}") }}
        <div class="invalid-feedback">Campo requerido</div>
      </div>
    {% endfor %}

    <!-- Botones -->
   {{ form.submit(class="btn btn-success") }}
    <a href="{{ url_for('medicos.listar_notas', id_consulta=consulta.id_consulta) }}" class="btn btn-secondary">Cancelar</a>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const pesoInput = document.getElementById("peso");
    const tallaInput = document.getElementById("talla");
    const imcInput = document.getElementById("imc");
    const form = document.getElementById("notaForm");

    function calcularIMC() {
        const peso = parseFloat(pesoInput.value);
        const talla = parseFloat(tallaInput.value);

        if (!isNaN(peso) && !isNaN(talla) && peso > 0 && talla > 0) {
            imcInput.value = (peso / (talla * talla)).toFixed(2);
        } else {
            imcInput.value = "";
        }
    }

    pesoInput.addEventListener("input", calcularIMC);
    tallaInput.addEventListener("input", calcularIMC);

    // Validación en tiempo real
    const camposNumericos = ['peso','talla','fc','fr','temp','spo2','glicemia'];
    const camposTexto = ['presentacion','antecedentes','exploracion_fisica','laboratorio','diagnostico','plan','pronostico'];

    form.addEventListener("submit", function(event) {
        let valido = true;

        // Validar select de servicio
        const servicio = form.querySelector("#id_servicio");
        if (!servicio.value) {
            servicio.classList.add("is-invalid");
            valido = false;
        } else {
            servicio.classList.remove("is-invalid");
        }

        // Validar campos numéricos
        camposNumericos.forEach(c => {
            const input = document.getElementById(c);
            const val = parseFloat(input.value);
            if (isNaN(val) || val < 0) {
                input.classList.add("is-invalid");
                valido = false;
            } else {
                input.classList.remove("is-invalid");
            }
        });

        // Validar campos de texto obligatorios
        camposTexto.forEach(c => {
            const input = form.querySelector(`[name="${c}"]`);
            if (!input.value.trim()) {
                input.classList.add("is-invalid");
                valido = false;
            } else {
                input.classList.remove("is-invalid");
            }
        });

        if (!valido) {
            event.preventDefault();
            event.stopPropagation();
        }
    });
});
</script>

{% endblock %}
