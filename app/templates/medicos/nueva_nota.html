{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Nueva Nota para Consulta #{{ consulta.id_consulta }}</h2>

  <!-- Mensajes flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST" id="notaForm">
    {{ form.hidden_tag() }}

    <!-- Fecha y Hora ocultas -->
    {{ form.fecha(class="form-control", type="hidden") }}
    {{ form.hora(class="form-control", type="hidden") }}

    <!-- Servicio -->
    <div class="mb-3">
      {{ form.id_servicio.label(class="form-label") }}
      {{ form.id_servicio(class="form-select") }}
      <div class="invalid-feedback">Debe seleccionar un servicio</div>
    </div>

    <!-- Médico Responsable (solo pasante) -->
   {% if es_pasante %}
    <div class="mb-3">
        <label for="medico_responsable" class="form-label">Médico Responsable</label>
        <select id="medico_responsable" name="medico_responsable" class="form-select" required>
            <option value="">Seleccione un médico</option>
            {% for medico in medicos_responsables %}
                <option value="{{ medico.id_usuario }}">{{ medico.usuario }}</option>
            {% endfor %}
        </select>
        <div class="invalid-feedback">Debe seleccionar un médico responsable</div>
    </div>
    {% endif %}

    <!-- Signos Vitales -->
    <h5>Signos Vitales</h5>
    <div class="row mb-3">
        <div class="col">{{ form.peso.label }} {{ form.peso(class="form-control", id="peso") }}</div>
        <div class="col">{{ form.talla.label }} {{ form.talla(class="form-control", id="talla") }}</div>
        <div class="col">
          <label for="imc" class="form-label">IMC</label>
          <input type="text" id="imc" class="form-control" value="{{ form.imc.data or '' }}" readonly>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col">{{ form.ta.label }} {{ form.ta(class="form-control") }}</div>
        <div class="col">{{ form.fc.label }} {{ form.fc(class="form-control") }}</div>
        <div class="col">{{ form.fr.label }} {{ form.fr(class="form-control") }}</div>
    </div>
    <div class="row mb-3">
        <div class="col">{{ form.temp.label }} {{ form.temp(class="form-control") }}</div>
        <div class="col">{{ form.cc.label }} {{ form.cc(class="form-control") }}</div>
        <div class="col">{{ form.spo2.label }} {{ form.spo2(class="form-control") }}</div>
        <div class="col">{{ form.glicemia.label }} {{ form.glicemia(class="form-control") }}</div>
    </div>

    <!-- SOAP -->
    <h4>SOAP</h4>
    {% for campo in ['antecedentes','exploracion_fisica','laboratorio','diagnostico','plan','pronostico'] %}
      <div class="mb-3">
        {{ form[campo].label }}
        {{ form[campo](class="form-control", rows="5", placeholder=form[campo].label.text) }}
        <div class="invalid-feedback">Campo requerido</div>
      </div>
    {% endfor %}

    <!-- Botones -->
    {{ form.submit(class="btn btn-success") }}
    <a href="{{ url_for('medicos.listar_notas', id_consulta=consulta.id_consulta) }}" class="btn btn-secondary">Cancelar</a>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Calcular IMC
    const pesoInput = document.getElementById("peso");
    const tallaInput = document.getElementById("talla");
    const imcInput = document.getElementById("imc");

    function calcularIMC() {
        const peso = parseFloat(pesoInput.value);
        const talla = parseFloat(tallaInput.value);
        if (!isNaN(peso) && !isNaN(talla) && talla > 0) {
            imcInput.value = (peso / (talla * talla)).toFixed(2);
        } else {
            imcInput.value = "";
        }
    }

    pesoInput.addEventListener("input", calcularIMC);
    tallaInput.addEventListener("input", calcularIMC);

    // Validación básica
    const form = document.getElementById("notaForm");
    form.addEventListener("submit", function(event) {
        let valido = true;

        {% if es_pasante %}
        const medicoSelect = document.getElementById("medico_responsable");
        if (!medicoSelect.value) {
            medicoSelect.classList.add("is-invalid");
            valido = false;
        } else {
            medicoSelect.classList.remove("is-invalid");
        }
        {% endif %}

        if (!valido) {
            event.preventDefault();
            event.stopPropagation();
        }
    });
});
</script>
{% endblock %}
