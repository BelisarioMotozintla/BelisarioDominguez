{% extends "base.html" %}
{% block content %}
<h2>Nueva Consulta General</h2>

<!-- Buscador de pacientes -->
<form method="GET" action="{{ url_for('consultas.nueva_consulta') }}" class="mb-3">
  <div class="input-group">
    <input type="text" name="q" class="form-control" value="{{ query }}" placeholder="Buscar por nombre, CURP o expediente">
    <button type="submit" class="btn btn-primary">Buscar</button>
  </div>
</form>

<form method="POST">
  <div class="form-group">
    <label>Paciente</label>

    {% if pacientes %}
      <select name="id_paciente" class="form-control" required>
        {% for p in pacientes %}
        <option value="{{ p.id_paciente }}">
          {{ p.nombre }} ({{ p.curp }}) - Expediente: 
          {{ p.archivo_clinico[0].numero_expediente if p.archivo_clinico else 'No asignado' }}
        </option>
        {% endfor %}
      </select>
    {% else %}
      <div class="alert alert-warning mt-2">
        No se encontraron pacientes para este médico.
      </div>
      <a href="{{ url_for('paciente.alta_paciente') }}" class="btn btn-sm btn-outline-primary mt-2" title="Registrar nuevo paciente">
        <i class="bi bi-person-fill"></i> Pacientes
      </a>
    {% endif %}
  </div>

  <p class="text-muted mt-3">
    Médico logueado: {{ current_user.username }}
  </p>

  {% if pacientes %}
    <button type="submit" class="btn btn-success mt-3">Registrar Consulta</button>
  {% endif %}
</form>
{% endblock %}
